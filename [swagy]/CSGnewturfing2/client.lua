turfSpawnTable = {

-- 2047.68, 692.62, 11.45
[1] = {1701.8564453125,682.2275390625,10.8203125,263.98626708984},

[2] = {1453.265625,756.8681640625,11.0234375,89.460296630859},

[3] = {1951.05859375,736.83984375,10.8203125,136.46051025391},

[4] = {2048.81, 691.3, 11.43 ,178.42346191406},

[5] = {2248.6572265625,694.2216796875,11.453125,357.00344848633},

[6] = {2354.109375,693.7431640625,11.4609375,357.31655883789},

[7] = {2601.11328125,746.3095703125,10.8203125,270.83633422852},

[8] = {2523.861328125,917.8134765625,10.8203125,274.59371948242},


[9] = {2475.5205078125,994.318359375,10.8203125,177.46209716797},


[10] = {2550.427734375,1053.3935546875,10.8203125,356.03662109375},


[11] = {2478.244140625,1270.29296875,10.8125,270.49575805664},


[12] = {2465.962890625,1405.7119140625,10.8203125,267.36462402344},


[13] = {2600.373046875,1439.83203125,10.8203125,83.725341796875},

[14] = {2531.86328125,1517.4091796875,10.818544387817,359.14581298828},


[15] = {2623.138671875,1716.904296875,11.0234375,91.075317382813},

[16] = {2569.6953125,1976.4609375,11.1640625,180.81300354004},


[17] = {2577.0361328125,2080.5439453125,10.812986373901,181.1261138916},


[18] = {2587.552734375,2370.6669921875,17.8203125,54.561676025391},


[19] = {2361.076171875,2310.109375,8.140625,0.66741943359375},

[20] = {2179.6005859375,1116.677734375,12.6484375,62.373077392578},

[21] = {2206.37890625,1269.896484375,10.8203125,85.246978759766},


[22] = {2322.27734375,1392.5029296875,10.8203125,357.19570922852},


[23] = {2171.6484375,1416.76953125,11.0625,84.933837890625},


[24] = {2001.0849609375,1527.720703125,14.6171875,356.88259887695},


[25] = {1988.00390625,1796.9140625,12.043745994568,85.246978759766},

[26] = {2046.40625,1916.318359375,12.280037879944,88.378112792969},

[27] = {2445.873046875,1659.5693359375,10.8203125,265.72763061523},

[28] = {2252.7646484375,1803.3359375,10.8203125,88.691223144531},

[29] = {2208.16796875,1968.419921875,10.8203125,90.740234375},

[30] = {2205.33984375,2065.2802734375,10.8203125,268.85876464844},

[31] = {2437.7265625,2125.78515625,10.8203125,358.47561645508},

[32] = {1933.736328125,1346.0693359375,9.96875,267.60632324219},

[33] = {2009.5126953125,1181.017578125,10.8203125,186.14144897461},

[34] = {1922.2158203125,964.7099609375,10.8203125,126.58364868164},


[35] = {1619.5302734375,1061.5419921875,10.8203125,357.19570922852},

[36] = {1465.2802734375,1088.7841796875,10.8203125,264.42572021484},

[37] = {1047.74609375,1016.8701171875,11,320.82489013672},

[38] = {1039.8740234375,1304.7421875,10.8203125,359.07989501953},

[39] = {1100.4326171875,1452.884765625,5.8203125,184.86152648926},


[40] = {1042.1748046875,1724.080078125,10.8203125,0.62347412109375},

[41] = {943.19140625,1733.8115234375,8.8515625,270.69351196289},

[42] = {1054.1123046875,1912.169921875,10.8203125,355.58618164063},

[43] = {973.021484375,1897.0693359375,11.4609375,175.14947509766},


[44] = {975.921875,2050.072265625,10.8203125,269.7541809082},

[45] = {1041.708984375,2009.6123046875,11.4609375,268.1611328125},

[46] = {1071.2294921875,2152.611328125,10.8203125,303.23550415039},

[47] = {1036.33203125,2330.712890625,11.261547088623,356.18493652344},

[48] = {950.57, 2274.61, 11.46,181.3458404541},

[49] = {971.2890625,2343.6416015625,11.46875,89.850311279297},

[50] = {1360.083984375,2210.7109375,12.015625,178.50036621094},


[51] = {1419.6005859375,2000.109375,10.8203125,266.83724975586},


[52] = {1762.2119140625,2107.029296875,10.831106185913,2.4087829589844},

[53] = {1863.6982421875,2003.3818359375,7.5945882797241,267.94689941406},

[54] = {1858.27734375,2236.2958984375,11.125,0.23895263671875},

[55] = {1860.978515625,2349.23046875,10.979915618896,178.18725585938},

[56] = {1615.91796875,2767.2734375,10.8203125,0.84323120117188},


[57] = {1819.8828125,2820.4609375,11.350912094116,253.3897857666},


[58] = {1881.033203125,2645.4033203125,10.8203125,179.12658691406},

[59] = {2315.01171875,2775.4736328125,10.8203125,85.752349853516},

[60] = {2589.8515625,2791.0673828125,10.8203125,89.202087402344},

[61] = {2833.962890625,2400.6240234375,11.068956375122,192.89265441895},

[62] = {2821.9443359375,2209.2919921875,10.8203125,86.070953369141},

[63] = {2806.505859375,2595.1982421875,10.8203125,42.828094482422},

[64] = {2869.4716796875,944.41796875,10.75,182.57633972168},

[65] = {1139.560546875,731.6982421875,10.81880569458,2.1176452636719},

[66] = {1484.67578125,2832.3583984375,10.8203125,180.07141113281},

--[67] = {3454.7673339844,2378.7189941406,9.2662696838379,180.07141113281},

--[68] = {1216.2017822266,2721.2944335938,10.8203125,180.07141113281},

}

local radStations = {
	[63] = "#1 LVPD", -- turf id 63
	[64] = "#2 LVPD", -- turf id 64
	[65] = "#3 LVPD", -- turf id 65
	[66] = "#4 LVPD", -- turf id 66
	--[76] = "LV Sea"
}

local stationToBlip = {
	[63] = 63,
	[64] = 64,
	[65] = 65,
	[66] = 66,
}

local blips = {
	[63] = false,
	[64] = false,
	[65] = false,
	[66] = false,
}

local blipStats = {
[63] = "crim",
[64] = "crim",
[65] = "crim",
[66] = "crim",
}

addEvent("synceClientTurfs",true)
addEventHandler("synceClientTurfs",root,function(id,st,owner)
	if blipStats[id] then
		if owner == "Unoccupied" then
			blipStats[id] = st
		elseif owner == "Aurora Law" then
			blipStats[id] = st
		elseif owner == "Criminals" then
			blipStats[id] = st
		end
	end
end)

function isLaw(p)
	if p and getPlayerTeam(p) then
	local tName = getTeamName(getPlayerTeam(p))
	if tName == "Government" or tName == "GIGN" or tName == "Military Forces" then
		return true
	end
	return false
	end
end

local gangName=""


local spawnTime = 3000
local LVcol = createColRectangle(675.86,516.25,2300,2500)
local seaCol = createColRectangle(2983.9, 356.8,850,2700)
local myCol = createColCircle(1,1,60)
attachElements(myCol,localPlayer)
-- When player dies spawn him in the nearest turf of his own group


local tp = {}
function findNearestTurf(turfs)
	local turf = nil
	local min = 99999999
	for key,val in ipairs(turfs) do
		local xx,yy,zz=getElementPosition(localPlayer)
		--local x1,y1,z1,turfID = val[1],val[2],val[3],val[4]
	    local dist = getDistanceBetweenPoints2D(xx,yy,val[1],val[2])
		if dist < min then
			turf = val
			min = dist
		end
	end
	return turf[1],turf[2],turf[3],turf[4]
end
local xx = {}
addEvent ("onClientTurferDied", true)
function onClientTurferDied (tables)
	local myGroup = getElementData(localPlayer,"Group")
	--for k,v in pairs(theTable) do
		--if v.owner == myGroup and v.health >= 55 and (not isElementWithinColShape(localPlayer,v.col)) then
	--		local x,y = getElementPosition(v.col)
	--		local z = 12
	--		table.insert(tp,{x,y,z,k})
			local x,y,z,id = findNearestTurf(tables)
			if id then

				setElementData(localPlayer,"x",turfSpawnTable[id][1])
				setElementData(localPlayer,"y",turfSpawnTable[id][2])
				setElementData(localPlayer,"z",turfSpawnTable[id][3])
				setElementData(localPlayer,"rot",turfSpawnTable[id][4])
			end
	--	end
	--end
end
addEventHandler ("onClientTurferDied", localPlayer, onClientTurferDied)


function AbsoluteToRelativ2( X, Y )
    local rX, rY = guiGetScreenSize()
    local x = math.floor(X*rX/1280)
    local y = math.floor(Y*rY/768)
    return x, y
end


function getActualG(v)
	local gr = getElementData(v,"Group")
			local a = getElementData(v,"alliance")
			if (a) then
				if (getElementData(v,"ta")==true) then
					return getElementData(v,"aName")
				else
					return gr
				end
			end
	return gr
end


currentTurfData = nil
local barTimer = false
addEvent("recTurfData",true)
addEventHandler("recTurfData",localPlayer,function(t) currentTurfData=t
	if isTimer(barTimer) then killTimer(barTimer) end
	if t == nil then return end
	myGroup=getActualG(localPlayer)
	local gr = myGroup
	if radStations[t.turfID] ~= nil then
		if gr == "GIGN" or teamName == "Government" or gr == "Military Forces" then gr = "Aurora Law" else gr = "Criminals" end
	end
	myGroup=gr
	if t.attackinggroup ~= myGroup and t.owner ~= myGroup then
		currentTurfData.text = "You are attacking this turf!"
		textr,textg,textb = 255,0,0
	elseif t.owner == myGroup then
		currentTurfData.text = "You are defending this turf!"
		textr,textg,textb = 0,255,0
		if t.health < 100 and t.health > t.oldHealth then
			triggerServerEvent("CSGturfing.reqDefendingMoney",localPlayer)
		end
	else
		currentTurfData.text = "You are attempting to take this turf!"
		textr,textg,textb = 255,255,0
	end
	local change = t.health - t.oldHealth
	change=change/100
	barTimer=setTimer(function() currentTurfData.health = currentTurfData.health + change end,50,100)
end)

towerString1 = ""
towerString2 = ""
towerr,towerg,towerb=0,0,0
oldzone = ""
zone=""
function doNearestTowerCalculations()
	local smallestDist = 9999999
	local id = 0
	local mx,my = getElementPosition(localPlayer)
	for k,v in pairs(blips) do
		local x,y = turfSpawnTable[k][1],turfSpawnTable[k][2]
		local dist = getDistanceBetweenPoints2D(mx,my,x,y)
		if dist < smallestDist then
			smallestDist=dist
			id=k
		end
	end
	if isElementWithinColShape(localPlayer,seaCol) then
		id = 76
	end
	if blipStats[id] == "law" then
		towerr,towerg,towerb = 0,0,255
		zone="law"
		towerString2 = "Law Territory"
	elseif blipStats[id] == "crim" then
		towerr,towerg,towerb = 255,0,0
		towerString2 = "Criminal Territory"
		zone="crim"
	elseif blipStats[id] == "noone" then
		towerr,towerg,towerb = 255,255,255
		towerString2 = "Neutral Territory"
		zone="noone"
	end
	if zone ~= oldzone then
		oldzone=zone
		triggerServerEvent("CSGwanted.wUpdate",localPlayer,zone)
	end
	if id == 63 then
		towerString1 = "NT - South East LV Radio Tower"
	elseif id == 64 then
		towerString1 = "NT - South West LV Radio Tower"
	elseif id == 65 then
		towerString1 = "NT - North East LV Radio Tower"
	elseif id == 66 then
		towerString1 = "NT - North West LV Radio Tower"
--	elseif id == 76 then
--		towerString1 = "NT - LV Sea Radio Tower"
	end
end

addEventHandler( "onClientRender", root,
    function ()
		if ( getElementInterior( localPlayer ) ~= 0 and getElementDimension( localPlayer ) ~= 0 ) or ( isPlayerMapVisible() ) then
			return
		end
		if isElementWithinColShape(localPlayer,LVcol) or isElementWithinColShape(localPlayer,seaCol) then
			x,y=AbsoluteToRelativ2(63, 737)
			x2,y2=AbsoluteToRelativ2(283, 762)
			dxDrawText(towerString1, x,y,x2,y2, tocolor(towerr,towerg,towerb, 255), 1, "default-bold", "center", "top" )
			x,y=AbsoluteToRelativ2(63, 750)
			x2,y2=AbsoluteToRelativ2(283, 775)
			dxDrawText(towerString2, x,y,x2,y2, tocolor(towerr,towerg,towerb, 255), 1, "default-bold", "center", "top" )
		end
		if currentTurfData == nil or not currentTurfData.health then return end
		x,y=AbsoluteToRelativ2(1002,238)
		x2,y2=AbsoluteToRelativ2(212, 21)
		if currentTurfData.attackinggroup == "None" then
			if currentTurfData.owner=="Unoccupied" then
				dxDrawRectangle(x,y,x2*(currentTurfData.health/100),y2, tocolor(255,255,255, 255), false )
			elseif (currentTurfData.colors[currentTurfData.owner]) then
				dxDrawRectangle(x,y,x2*(currentTurfData.health/100),y2, tocolor(currentTurfData.colors[currentTurfData.owner][1],currentTurfData.colors[currentTurfData.owner][2],currentTurfData.colors[currentTurfData.owner][3], 255), false)
			else
				dxDrawRectangle(x,y,x2*(currentTurfData.health/100),y2, tocolor(255,255,255, 255), false )
			end
		else
			dxDrawRectangle(x,y,x2*(currentTurfData.health/100),y2, tocolor(currentTurfData.colors[currentTurfData.attackinggroup][1],currentTurfData.colors[currentTurfData.attackinggroup][2],currentTurfData.colors[currentTurfData.attackinggroup][3], 255), false)
		end

		x,y=AbsoluteToRelativ2(1000, 234)
		x2,y2=AbsoluteToRelativ2(217, 30)
		dxDrawRectangle(x,y,x2,y2, tocolor(19, 0, 0, 100), false )

		x,y=AbsoluteToRelativ2(1120, 234)
		x2,y2=AbsoluteToRelativ2(1120, 262)
		dxDrawLine(x,y,x2,y2, tocolor(9, 130, 0, 255), 1, false )

		x,y=AbsoluteToRelativ2(1041, 234)
		x2,y2=AbsoluteToRelativ2(1041, 262)
		dxDrawLine(x,y,x2,y2, tocolor(129, 2, 20, 255), 1, false )

		x,y=AbsoluteToRelativ2(996, 236)
		x2,y2=AbsoluteToRelativ2(1224, 262)
		dxDrawText(currentTurfData.barText, x,y,x2,y2, tocolor(255, 255, 255, 255), 1, "default", "center", "center" )

		x,y=AbsoluteToRelativ2(1001, 292)
		x2,y2=AbsoluteToRelativ2(1216, 318)
		dxDrawText(">> Turf Influence <<", x,y,x2,y2, tocolor(255, 255, 255, 255), 1, "default-bold", "center", "top" )

		local i=1
		for k,v in pairs(currentTurfData.influences) do
			local mult = 10^2

			if k ~= "Aurora Law" and k ~= "Criminals" then
			i=i+1
			local imgY=292+(30*(i-1))
			 _,imgY=AbsoluteToRelativ2(0,imgY-7)
			x,y=AbsoluteToRelativ2(1001, 292+(30*(i-1)))
			x2,y2=AbsoluteToRelativ2(1216, 318)
			v=v/2
			v = (math.floor(v * mult + 0.5) / mult)
			--v=math.floor(v)
			local vpos = v
			local vnum = v

			if v < 0 then vpos=vpos*-1 end
			local timesToDrawFull = math.floor(vpos)
			local timesToDrawHalf = 0
			if vpos-timesToDrawFull > 0 then timesToDrawHalf=1 end
			if v > 0 then v="+"..v..""end
			dxDrawText(""..k.."", x,y,x2,y2, tocolor(currentTurfData.colors[k][1], currentTurfData.colors[k][2], currentTurfData.colors[k][3], 255), 1, "default", "center", "top" )
			for i2=1,timesToDrawFull do
			if vnum > 0 then
				x3,y3=AbsoluteToRelativ2(1161+(30*(i2-1)), 317)
			else
				x3,y3=AbsoluteToRelativ2(1031-(30*(i2-1)), 317)
			end
			x4,y4=AbsoluteToRelativ2(36, 26)
			dxDrawImage(x3,imgY,x4,y4, "full.png", 0, 0, 0, tocolor(255, 255, 255, 255), false)
			end
			if timesToDrawHalf > 0 then
			if vnum > 0 then
				x3,y3=AbsoluteToRelativ2(1161+(30*(timesToDrawFull+1-1)), 317)
			else
				x3,y3=AbsoluteToRelativ2(1031-(30*(timesToDrawFull+1-1)), 317)
			end
			dxDrawImage( x3,imgY,x4,y4, "half.png", 0, 0, 0, tocolor( 255, 255, 255, 255 ), false )
			end
			end
		end

		x,y=AbsoluteToRelativ2(1001, 265)
		x2,y2=AbsoluteToRelativ2(1216, 291)
		dxDrawText(""..currentTurfData.text.."", x,y,x2,y2, tocolor(textr,textg,textb, 255), 1, "default", "left", "top" )

    end
)

setTimer(
	function()
	if (isElementWithinColShape(localPlayer,LVcol) or isElementWithinColShape(localPlayer,seaCol)) and getElementDimension(localPlayer) == 0 and getElementInterior(localPlayer) == 0 then
		doNearestTowerCalculations()
		for k,v in pairs(blips) do
			if v == false then
				blips[k] = exports.customblips:createCustomBlip ( turfSpawnTable[k][1], turfSpawnTable[k][2], 20, 20, ""..blipStats[k]..".png", 999999 )
			end
		end
	else
		if not (exports.server:isPlayerLoggedIn(localPlayer)) then return end
		local teamName = getTeamName(getPlayerTeam(localPlayer))
		if teamName ~= "Criminals" and teamName ~= "Staff" and getElementDimension(localPlayer) == 0 and getElementInterior(localPlayer) == 0 then
			if isLaw(localPlayer) == false then
				for k,v in pairs(blips) do
					if v ~= false then exports.customblips:destroyCustomBlip(v) blips[k] = false end
				end
			end
		elseif (teamName == "Criminals" or teamName == "Staff" or isLaw(localPlayer)) and getElementDimension(localPlayer) == 0 and getElementInterior(localPlayer) == 0 then
			for k,v in pairs(blips) do
				if v == false then
					blips[k] = exports.customblips:createCustomBlip ( turfSpawnTable[k][1], turfSpawnTable[k][2], 20, 20, ""..blipStats[k]..".png", 999999 )
				end
			end
		else
			for k,v in pairs(blips) do
				if v ~= false then exports.customblips:destroyCustomBlip(v) blips[k] = false end
			end
		end
	end
end,2500,0)

addEvent("CSGturfing.updateBlips",true)
addEventHandler("CSGturfing.updateBlips",localPlayer,function(i,v)
	if stationToBlip[i] == nil then return end
	blipStats[stationToBlip[i]] = v
	for k,v in pairs(blips) do
		if v ~= false then
			exports.customblips:destroyCustomBlip(v)
			blips[k]=exports.customblips:createCustomBlip ( turfSpawnTable[k][1], turfSpawnTable[k][2], 20, 20, ""..blipStats[k]..".png", 999999 )
		else
			blips[k]=exports.customblips:createCustomBlip ( turfSpawnTable[k][1], turfSpawnTable[k][2], 20, 20, ""..blipStats[k]..".png", 999999 )
		end
	end
	doNearestTowerCalculations()
	triggerEvent("CSGturfing.towerUpdates",localPlayer,blipStats)
end)


LV = createColRectangle(901.67871, 601.66272, 2750, 2400)

function isElementInLV(ele)
	if (not ele or not isElement(ele)) then return nil end
	if (isElementWithinColShape(ele, LV)) then
		return true
	end
	return false
end
--getTurfTimer
myTime = nil
LVCRIMS = {}
addEvent("addTurfingTimer",true)
addEventHandler("addTurfingTimer",root,function(prm)
	if isTimer(myTime) then killTimer(myTime) end
	myTime = setTimer(function() end,prm,1)
end)


addEventHandler("onClientResourceStart",resourceRoot,function()
	setTimer(function()
		triggerServerEvent("getTurfTimer",localPlayer)
	end,5000,1)
	setTimer(function()
		LVCRIMS = {}
		for i, v in pairs ( getElementsByType ( 'player' ) ) do
			if isElementInLV(v) and getPlayerTeam(v) and getTeamName(getPlayerTeam(v)) == "Criminals" then
				table.insert(LVCRIMS,v)
			end
		end
	end,10000,0)
end)


function convertTime(ms)
    local min = math.floor ( ms/60000 )
    local sec = math.floor( (ms/1000)%60 )
    return min, sec
end


local screenW, screenH = guiGetScreenSize()
local screenWidth, screenHeight = guiGetScreenSize()

function dxDraw( text, wh, x, y, w, h, clr, scale, font, alignX, alignY, clip, wordBreak, postGUI )
	if not wh then wh = 1.5 end
	dxDrawText ( text, x - wh, y - wh, w - wh, h - wh, tocolor ( 0, 0, 0, a ), scale, font, alignX, alignY, clip, wordBreak, false, true) -- black
	dxDrawText ( text, x + wh, y - wh, w + wh, h - wh, tocolor ( 0, 0, 0, a ), scale, font, alignX, alignY, clip, wordBreak, false, true)
	dxDrawText ( text, x - wh, y + wh, w - wh, h + wh, tocolor ( 0, 0, 0, a ), scale, font, alignX, alignY, clip, wordBreak, false, true)
	dxDrawText ( text, x + wh, y + wh, w + wh, h + wh, tocolor ( 0, 0, 0, a ), scale, font, alignX, alignY, clip, wordBreak, false, true)
	dxDrawText ( text, x - wh, y, w - wh, h, tocolor ( 0, 0, 0, a ), scale, font, alignX, alignY, clip, wordBreak, false, true)
	dxDrawText ( text, x + wh, y, w + wh, h, tocolor ( 0, 0, 0, a ), scale, font, alignX, alignY, clip, wordBreak, false, true)
	dxDrawText ( text, x, y - wh, w, h - wh, tocolor ( 0, 0, 0, a ), scale, font, alignX, alignY, clip, wordBreak, false, true)
	dxDrawText ( text, x, y + wh, w, h + wh, tocolor ( 0, 0, 0, a ), scale, font, alignX, alignY, clip, wordBreak, false, true)
	dxDrawText ( text, x, y, w, h, clr, scale, font, alignX, alignY, clip, wordBreak, postGUI, true)
end

LVCRIMS = {}
local screenWidth, screenHeight = guiGetScreenSize()
function createText()
	setElementData(localPlayer, "inLV", isElementInLV(localPlayer))
	if getPlayerTeam(localPlayer) then
		if getTeamName(getPlayerTeam(localPlayer)) == "Criminals" then
			if isElementInLV(localPlayer) then
				if myTime and isTimer(myTime) then
					local timeLeft, timeExLeft, timeExMax = getTimerDetails(myTime)
					if timeLeft and tonumber(timeLeft) > 0 then
						if #LVCRIMS >= 4 then
							local minutes, seconds = convertTime(timeLeft)
							dxDraw("Turfing payment: ( ".. math.floor(minutes) .." minutes : "..math.floor(seconds) .." seconds)", 1.75, (screenW - 504) / 2, (screenH - 55) / 1.05, ((screenW - 504) / 2) + 504, ( (screenH - 44) / 1.05) + 44, tocolor(200,0,0, 195), 0.6, "pricedown", "center", "center", false, false, true, false, false)
						else
							dxDraw("4+ Criminals required in LV to start turfing payment", 1.75, (screenW - 504) / 2, (screenH - 15) / 1.05, ((screenW - 504) / 2) + 504, ( (screenH - 44) / 1.05) + 44, tocolor(200,0,0, 195), 0.6, "pricedown", "center", "center", false, false, true, false, false)
						end
					end
				end
			end
		end
	end
end
addEventHandler("onClientRender",root,createText)
